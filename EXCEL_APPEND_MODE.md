# Excel导出追加模式功能说明

## 功能概述
新增Excel导出追加模式功能，用户可自选追加写入或新建导出，解决不同模型导出时可能的写入失败问题。

## 主要特性

### 1. 追加模式
- **启用方式**：勾选工具栏的"追加模式"复选框
- **功能**：
  - 自动读取现有Excel文件的数据
  - 智能合并表头结构（支持不同区域数量的数据）
  - 序号从现有数据最大序号+1开始连续编号
  - 保留原有数据，新数据追加到末尾
- **适用场景**：
  - 分批处理文件，需要累积到同一个Excel
  - 需要合并多次识别结果

### 2. 新建模式（默认）
- **启用方式**：不勾选"追加模式"复选框
- **功能**：
  - 如文件不存在，直接创建
  - 如文件已存在，自动生成唯一文件名（Windows风格括号序号）
  - 文件命名规则：`文件名(1).xlsx`, `文件名(2).xlsx`, ...
- **适用场景**：
  - 每次导出独立的Excel文件
  - 避免覆盖已有文件

### 3. 智能表头合并
- 追加模式下，自动检测现有数据和新数据的最大区域数
- 统一使用更大的区域数作为表头
- 数据较少的行自动补齐空列

## 代码改动详情

### 修改文件
1. **utils.py**
   - `FileUtils.get_unique_filename()` - 使用Windows风格括号序号
   - `ExcelExporter.load_existing_data()` - 新增，读取现有Excel数据
   - `ExcelExporter.export_results()` - 添加 `append_mode` 参数

2. **qt_main.py**
   - 导入 `QCheckBox`
   - 添加追加模式勾选框到工具栏
   - `export_excel()` 方法传递追加模式参数

## 测试指南

### 测试1：新建模式 - 唯一文件名生成
1. 启动应用程序
2. 打开一些图片文件
3. 进行OCR识别
4. **不勾选**"追加模式"
5. 点击"导出Excel"，保存为 `test.xlsx`
6. 再次点击"导出Excel"，保存相同文件名 `test.xlsx`
7. **预期结果**：自动生成 `test(1).xlsx`
8. 再次导出相同文件名
9. **预期结果**：自动生成 `test(2).xlsx`

### 测试2：追加模式 - 数据合并
1. 启动应用程序
2. 打开文件A，识别（假设有2个区域）
3. **不勾选**"追加模式"，导出为 `result.xlsx`
4. 查看Excel：应有1条数据，序号为1
5. 关闭应用，重新启动
6. 打开文件B，识别（假设有3个区域）
7. **勾选**"追加模式"，导出选择 `result.xlsx`
8. **预期结果**：
   - Excel中有2条数据
   - 序号分别为1和2
   - 表头有3个区域列（取最大值）
   - 文件A的第3个区域列为空

### 测试3：追加模式 - 文件不存在
1. **勾选**"追加模式"
2. 导出时选择一个不存在的文件名 `new_file.xlsx`
3. **预期结果**：自动创建新文件（与新建模式相同）

### 测试4：追加模式 - 读取失败容错
1. 创建一个损坏的或非Excel格式的 `broken.xlsx` 文件
2. **勾选**"追加模式"
3. 尝试导出到 `broken.xlsx`
4. **预期结果**：控制台打印错误信息，但继续创建新文件

## 技术实现细节

### 追加模式流程
```
1. 检查目标文件是否存在
2. 如存在，调用 load_existing_data() 读取
3. 解析表头，获取现有区域数量
4. 读取所有数据行（跳过表头）
5. 计算现有数据最大序号
6. 合并新旧数据的最大区域数
7. 创建新工作簿，写入统一表头
8. 先写入旧数据（补齐列）
9. 写入新数据（序号连续）
10. 保存到原文件路径
```

### 新建模式流程
```
1. 检查目标文件是否存在
2. 如存在，调用 get_unique_filename() 生成新名称
3. 创建工作簿，写入数据
4. 保存到新文件路径
```

## 注意事项
1. 追加模式会读取并重写整个Excel文件，大文件可能较慢
2. 文件被其他程序占用时会导出失败
3. 追加模式下，时间戳显示的是导出时间，而非实际识别时间
4. 序号在追加模式下会自动连续，确保数据完整性

## 版本信息
- 功能版本：v1.1.0
- 实施日期：2024-11-26
- 分支：feature/excel_append_mode_20241126
