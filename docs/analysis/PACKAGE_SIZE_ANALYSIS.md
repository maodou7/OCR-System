# 打包体积分析工具使用指南

## 概述

`analyze_package_size.py` 是一个用于分析PyInstaller打包后程序体积的工具。它可以帮助识别大文件、统计文件类型分布，并提供优化建议。

## 功能特性

- ✅ 分析dist目录中的所有文件
- ✅ 按大小排序显示最大的20个文件
- ✅ 按文件类型统计（DLL、PYD、EXE等）
- ✅ 识别可优化的大文件
- ✅ 生成详细的Markdown格式报告
- ✅ 提供针对性的优化建议

## 使用方法

### 基本用法

```bash
# 分析默认路径 (Pack/Pyinstaller/dist/OCR-System/)
python analyze_package_size.py

# 分析指定路径
python analyze_package_size.py <dist_path>

# 示例：分析自定义dist目录
python analyze_package_size.py "C:\MyProject\dist\MyApp"
```

### 前置条件

在使用分析工具之前，需要先完成打包：

```bash
cd Pack/Pyinstaller
python -m PyInstaller ocr_system.spec
```

## 输出说明

### 控制台输出

工具会在控制台输出以下信息：

1. **总体统计**
   - 文件总数
   - 总体积

2. **最大的20个文件**
   - 按大小降序排列
   - 显示文件大小和路径

3. **按文件类型统计**
   - 各类型文件的数量
   - 各类型文件的总大小
   - 占总体积的百分比

4. **优化建议**
   - 大型DLL文件（>5MB）
   - 大型PYD文件（>1MB）
   - Qt/PySide6相关文件统计
   - OCR模型文件统计
   - Python库文件统计

### Markdown报告

工具会自动生成 `package_size_report.md` 文件，包含：

- 总体统计表格
- 最大文件列表
- 文件类型统计表格
- 详细的优化建议

## 输出示例

```
================================================================================
打包体积分析报告
================================================================================

📊 总体统计:
   文件总数: 1234
   总体积: 456.78 MB

================================================================================
📦 最大的20个文件
================================================================================

          大小  文件路径
--------------------------------------------------------------------------------
    50.00 MB  Qt6Core.dll
    45.00 MB  PySide6/Qt6Widgets.dll
    30.00 MB  models/model_det.pdmodel
    ...

================================================================================
📁 按文件类型统计
================================================================================

文件类型                       数量          总大小       占比
--------------------------------------------------------------------------------
.dll                      120    250.00 MB   54.72%
.pyd                       45     80.00 MB   17.51%
.exe                        1     50.00 MB   10.94%
...

================================================================================
💡 优化建议
================================================================================

1. 大型DLL文件 (>5MB):
   •   50.00 MB  Qt6Core.dll
   •   45.00 MB  PySide6\Qt6Widgets.dll
   ...

3. Qt/PySide6相关文件:
   总数: 150
   总大小: 200.00 MB
   占比: 43.78%
   建议: 排除未使用的Qt模块和插件

4. OCR模型文件:
   总数: 20
   总大小: 100.00 MB
   占比: 21.89%
   建议: 移除非中英文模型，或设为可选下载
```

## 优化建议解读

### 1. 大型DLL文件

如果发现大型DLL文件（>5MB），可以考虑：

- 检查是否为必需的依赖
- 使用UPX压缩DLL文件
- 排除未使用的Qt插件

### 2. Qt/PySide6优化

如果Qt相关文件占比过高（>40%），可以：

- 在spec文件中明确指定需要的Qt模块
- 排除未使用的Qt插件（platforms、styles等）
- 排除Qt翻译文件

### 3. OCR模型优化

如果模型文件占比过高，可以：

- 移除非中英文语言模型
- 使用mobile版本替代server版本
- 将模型设为可选下载

### 4. Python库优化

如果Python库文件过多，可以：

- 移除未使用的依赖
- 使用更轻量的替代库
- 实现按需加载机制

## 测试

运行测试以验证工具功能：

```bash
python test_analyze_package_size.py
```

测试覆盖：
- ✅ 文件大小格式化
- ✅ 文件扩展名识别
- ✅ 目录分析功能
- ✅ 报告生成功能
- ✅ 错误处理

## 集成到CI/CD

可以将此工具集成到构建流程中：

```bash
# 打包
python -m PyInstaller ocr_system.spec

# 分析体积
python analyze_package_size.py Pack/Pyinstaller/dist/OCR-System

# 检查体积是否超标
python -c "
import os
size = sum(os.path.getsize(os.path.join(r,f)) for r,d,fs in os.walk('Pack/Pyinstaller/dist/OCR-System') for f in fs)
size_mb = size / 1024 / 1024
print(f'Total size: {size_mb:.2f} MB')
assert size_mb < 100, f'Package size {size_mb:.2f} MB exceeds limit of 100 MB'
"
```

## 相关文件

- `analyze_package_size.py` - 主分析脚本
- `test_analyze_package_size.py` - 测试脚本
- `package_size_report.md` - 生成的分析报告（自动创建）

## 故障排除

### 问题：目录不存在

```
❌ 错误: 目录不存在: Pack/Pyinstaller/dist/OCR-System
```

**解决方案**：先执行打包命令创建dist目录

### 问题：权限错误

如果遇到文件访问权限错误，请确保：
- 以管理员权限运行
- 目标目录没有被其他程序占用

### 问题：报告文件无法创建

如果报告文件无法创建，请检查：
- 当前目录是否有写入权限
- 磁盘空间是否充足

## 版本历史

- v1.0 - 初始版本
  - 基本的目录分析功能
  - 文件类型统计
  - 优化建议生成
  - Markdown报告输出
